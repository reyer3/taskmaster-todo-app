# Nombre del workflow
name: Deploy to urbanlink.pe

# Disparadores del workflow
on:
  # Se ejecuta en cada push a la rama main
  push:
    branches:
      - main
  # Permite ejecuci√≥n manual desde la interfaz de GitHub Actions
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Trabajos a ejecutar
jobs:
  # Trabajo para ejecutar pruebas del backend
  test:
    name: Test Backend
    runs-on: ubuntu-latest # Usa la √∫ltima versi√≥n de Ubuntu
    steps:
      # 1. Descarga el c√≥digo del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configura Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Usa Node.js versi√≥n 18
          cache: 'npm' # Habilita cach√© para npm
          cache-dependency-path: backend/package-lock.json # Ruta para la cach√©

      # 3. Instala dependencias del backend
      - name: Install dependencies
        working-directory: backend # Ejecuta en el directorio backend
        run: npm ci # Instala dependencias limpiamente

      # 4. Ejecuta las pruebas del backend
      - name: Run tests
        working-directory: backend
        run: npm test

  # Trabajo para construir y desplegar la aplicaci√≥n
  build-and-deploy:
    name: Build & Deploy
    needs: test # Depende del trabajo 'test'
    runs-on: ubuntu-latest
    steps:
      # 1. Descarga el c√≥digo del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configura el agente SSH para la conexi√≥n al servidor
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} # Clave privada SSH desde los secrets
      # 3. A√±ade la clave p√∫blica del host al archivo known_hosts
      - name: Setup known_hosts
        run: |
          mkdir -p ~/.ssh # Crea el directorio .ssh si no existe
          # Escanea y a√±ade la clave del host
          ssh-keyscan -t rsa,ecdsa,ed25519 ${{ secrets.HOST_IP }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts # Asegura los permisos correctos

      # 4. Construcci√≥n del Frontend
      - name: Setup Node.js for frontend
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build # Ejecuta el script de construcci√≥n del frontend
        env:
          # Variables de entorno para la construcci√≥n del frontend
          VITE_API_URL: https://api.taskmaster.urbanlink.pe
          NODE_ENV: production

      # 5. Instalaci√≥n de dependencias del Backend (solo producci√≥n)
      - name: Setup Node.js for backend
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies (production only)
        working-directory: backend
        run: npm ci --production # Instala solo dependencias de producci√≥n

      # 6. Preparar el paquete de despliegue
      - name: Prepare deployment package
        run: |
          # A√±adir versi√≥n y timestamp al despliegue
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_VERSION="${GITHUB_SHA::8}" # Usa los primeros 8 caracteres del hash del commit como versi√≥n

          # Crear archivo de versi√≥n
          echo "{\"version\":\"${BUILD_VERSION}\",\"date\":\"${BUILD_DATE}\",\"commit\":\"$GITHUB_SHA\"}" > version.json

          # Crear directorio de despliegue
          mkdir -p deploy

          # Copiar archivos de configuraci√≥n y necesarios
          cp docker-compose.yml deploy/
          cp -r traefik deploy/
          cp version.json deploy/

          # Copiar archivos del Frontend
          mkdir -p deploy/frontend
          cp -r frontend/dist deploy/frontend/
          cp frontend/nginx.conf deploy/frontend/
          cp frontend/Dockerfile deploy/frontend/

          # Copiar archivos del Backend
          mkdir -p deploy/backend
          cp -r backend/src deploy/backend/
          cp backend/package.json backend/package-lock.json backend/Dockerfile deploy/backend/
          cp -r backend/node_modules deploy/backend/ # Copia node_modules ya instalados

          # Crear el archivo tar.gz comprimido del paquete
          tar -czf taskmaster-deploy-${BUILD_VERSION}.tar.gz -C deploy .

          # Guardar la versi√≥n para usarla en pasos posteriores
          echo "BUILD_VERSION=${BUILD_VERSION}" >> $GITHUB_ENV

      # 7. Desplegar al servidor
      - name: Copy files to server
        run: |
          # Crear directorio de despliegue en el servidor si no existe
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "mkdir -p ~/taskmaster"

          # Copiar el paquete de despliegue al servidor
          scp taskmaster-deploy-${BUILD_VERSION}.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }}:~/taskmaster/

          # Extraer el paquete en el servidor
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "cd ~/taskmaster && tar -xzf taskmaster-deploy-${BUILD_VERSION}.tar.gz"

      # 8. Configurar entorno y desplegar con Docker Compose
      - name: Setup environment and deploy
        run: |
          # Crear archivo .env en el servidor con las variables de entorno necesarias
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "cat > ~/taskmaster/.env << 'EOL'
          # Variables generadas autom√°ticamente por GitHub Actions - $(date -u)
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION || '1d' }}
          JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION || '7d' }}
          CLOUDFLARE_EMAIL=${{ secrets.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_API_KEY=${{ secrets.CLOUDFLARE_API_KEY }}
          COMPOSE_PROJECT_NAME=taskmaster
          NODE_ENV=production
          CORS_ORIGIN=https://taskmaster.urbanlink.pe
          ENABLE_NOTIFICATIONS=true
          ENABLE_WEBSOCKETS=true
          EOL"

          # Asegurar permisos adecuados para el archivo .env
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "chmod 600 ~/taskmaster/.env"

          # Crear la red 'web' de Docker si no existe (para Traefik)
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "docker network create web || true"

          # Crear archivo acme.json para certificados Let's Encrypt si no existe y asegurar permisos
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "mkdir -p ~/taskmaster/traefik/config && test -f ~/taskmaster/traefik/config/acme.json || (touch ~/taskmaster/traefik/config/acme.json && chmod 600 ~/taskmaster/traefik/config/acme.json)"

          # Detener contenedores actuales, reconstruir y levantar los nuevos con docker-compose
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "cd ~/taskmaster && docker-compose down && docker-compose up -d --build"

      # 9. Verificar el despliegue
      - name: Verify deployment
        run: |
          # Verificar que los contenedores est√©n en ejecuci√≥n
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "cd ~/taskmaster && docker-compose ps"

          # Esperar un tiempo prudencial para que los servicios inicien
          echo "Esperando a que los servicios est√©n disponibles..."
          sleep 15

          # Verificar que el endpoint de salud del backend responde correctamente
          if curl -s --retry 3 --max-time 10 https://api.taskmaster.urbanlink.pe/health | grep -q "OK"; then
            echo "‚úÖ Backend API est√° funcionando correctamente"
          else
            echo "‚ùå Backend API no responde correctamente"
            exit 1 # Falla el workflow si el backend no responde
          fi

          # Verificar que el frontend responde con c√≥digo 200 OK
          if curl -s --retry 3 --max-time 10 -I https://taskmaster.urbanlink.pe | grep -q "200 OK"; then
            echo "‚úÖ Frontend est√° funcionando correctamente"
          else
            echo "‚ùå Frontend no responde correctamente"
            exit 1 # Falla el workflow si el frontend no responde
          fi

      # 10. Limpieza y optimizaci√≥n post-despliegue
      - name: Clean up
        run: |
          # Eliminar im√°genes de Docker antiguas no utilizadas para liberar espacio
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "docker image prune -af --filter 'until=24h'"

          # Eliminar paquetes de despliegue antiguos (m√°s de 7 d√≠as)
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "find ~/taskmaster -name 'taskmaster-deploy-*.tar.gz' -type f -mtime +7 -delete"

          # Guardar la versi√≥n actual desplegada en un archivo
          ssh -p 2222 ${{ secrets.SSH_USER }}@${{ secrets.HOST_IP }} "echo '${BUILD_VERSION}' > ~/taskmaster/CURRENT_VERSION"

          echo "üöÄ Despliegue completado con √©xito. Versi√≥n: ${BUILD_VERSION}"

      # 11. Notificar el resultado del despliegue a Slack (opcional)
      - name: Notify deployment
        if: always() # Se ejecuta siempre, incluso si pasos anteriores fallaron
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }} # Webhook de Slack desde secrets
          SLACK_CHANNEL: deploys # Canal de Slack
          SLACK_COLOR: ${{ job.status }} # Color basado en el estado del job (success, failure)
          SLACK_TITLE: "Despliegue a Producci√≥n"
          SLACK_MESSAGE: "TaskMaster v${BUILD_VERSION} - ${{ job.status == 'success' && '‚úÖ Despliegue exitoso' || '‚ùå Despliegue fallido' }}"
          SLACK_FOOTER: "GitHub Actions"
          MSG_MINIMAL: false # Formato no minimalista del mensaje
        continue-on-error: true # No falla el workflow si la notificaci√≥n falla
